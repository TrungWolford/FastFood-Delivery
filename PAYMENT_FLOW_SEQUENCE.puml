@startuml Payment Processing Flow (ReturnURL Only)
!theme plain
skinparam sequenceMessageAlign center
skinparam backgroundColor #FEFEFE
skinparam actorBackgroundColor #CCCCCC
skinparam actorBorderColor #000000
skinparam actorFontStyle bold
skinparam noteBackgroundColor #FFFFE0
skinparam noteBorderColor #000000

participant "ğŸ‘¤ KhÃ¡ch hÃ ng\n(TrÃ¬nh duyá»‡t)" as Customer
participant "ğŸŒ Frontend\n(React/Vue)" as Frontend
participant "ğŸ”§ Backend\n(Spring Boot)" as Backend
participant "ğŸ—„ï¸ MongoDB\n(Database)" as Database
participant "ğŸ’³ VNPay\n(Cá»•ng thanh toÃ¡n)" as VNPay

== Giai Ä‘oáº¡n 1: Chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n ==

Customer -> Frontend: 1. Chá»n thanh toÃ¡n tá»« giá» hÃ ng\n(Giá» hÃ ng cÃ³ sáº£n pháº©m, sáº£n pháº©m cÃ²n hÃ ng)
activate Frontend
Frontend -> Frontend: XÃ¡c thá»±c giá» hÃ ng\n& kho hÃ ng
note right: âœ“ Giá» hÃ ng khÃ´ng rá»—ng\nâœ“ Táº¥t cáº£ sáº£n pháº©m cÃ²n hÃ ng\nâœ“ Sá»‘ lÆ°á»£ng há»£p lá»‡
Frontend -> Frontend: Chuyá»ƒn Ä‘áº¿n\ntrang thanh toÃ¡n
Customer <- Frontend: 2. Hiá»ƒn thá»‹ trang thanh toÃ¡n
deactivate Frontend

Customer -> Frontend: 3. Äiá»n thÃ´ng tin giao hÃ ng\n(Äá»‹a chá»‰, SÄT, v.v.)
Customer -> Frontend: 4. Chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n\n(COD or VNPay)

== Giai Ä‘oáº¡n 2A: Luá»“ng thanh toÃ¡n COD ==

alt PhÆ°Æ¡ng thá»©c = COD

activate Frontend
Frontend -> Backend: 5a. POST /api/orders\n{cartItems, deliveryAddress,\nmethod: "COD"}
deactivate Frontend

activate Backend
note right: ğŸ”„ Táº¡o ÄÆ¡n hÃ ng & Thanh toÃ¡n\n(Luá»“ng COD)

Backend -> Database: 6a. LÆ°u Order\n{status: "PENDING", items[], amount}
activate Database
Database --> Backend: ÄÃ£ táº¡o Order vá»›i ID
deactivate Database

Backend -> Database: 7a. LÆ°u Payment\n{status: "PENDING", method: "COD",\norderRef, amount}
activate Database
Database --> Backend: ÄÃ£ táº¡o Payment
deactivate Database

note right: ğŸ“ Vá»›i COD:\n - Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng: PENDING\n - Tráº¡ng thÃ¡i thanh toÃ¡n: PENDING

Backend --> Frontend: 8a. Tráº£ vá» {orderId, status}
deactivate Backend

activate Frontend
Frontend --> Customer: 9a. Hiá»ƒn thá»‹ xÃ¡c nháº­n\n"ÄÃ£ táº¡o Ä‘Æ¡n hÃ ng - Chá» xÃ¡c nháº­n COD"


== Giai Ä‘oáº¡n 2B: Luá»“ng thanh toÃ¡n VNPay ==

else PhÆ°Æ¡ng thá»©c = VNPay

activate Frontend
Frontend -> Backend: 5b. POST /api/orders\n{cartItems, deliveryAddress,\nmethod: "VNPay"}
deactivate Frontend

activate Backend
note right: ğŸ”„ Táº¡o ÄÆ¡n hÃ ng & Thanh toÃ¡n\n(Luá»“ng VNPay)

Backend -> Database: 6b. LÆ°u Order\n{status: "PENDING", items[],\namount}
activate Database
Database --> Backend: ÄÃ£ táº¡o Order vá»›i ID (orderId)
deactivate Database

Backend -> Database: 7b. LÆ°u Payment\n{status: "PENDING", method: "VNPay",\norderRef: orderId, amount, vnpTxnRef}
activate Database
Database --> Backend: ÄÃ£ táº¡o Payment
deactivate Database

note right: ğŸ“ Vá»›i VNPay:\n - Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng: PENDING\n - Tráº¡ng thÃ¡i thanh toÃ¡n: PENDING\n - ÄÃ£ táº¡o TxnRef (UUID)

Backend -> Backend: Táº¡o VNPay URL\n(tham sá»‘ + checksum)
note right
    ğŸ” VNPay URL bao gá»“m:
     - vnp_Amount (sá»‘ tiá»n * 100)
     - vnp_TxnRef (mÃ£ thanh toÃ¡n duy nháº¥t)
     - vnp_ReturnUrl (Endpoint cá»§a Backend)
     - vnp_CreateDate (GMT+7)
     - vnp_ExpireDate (GMT+7 + 15 phÃºt)
     - vnp_SecureHash (HMAC-SHA512)
end note

Backend --> Frontend: 8b. Tráº£ vá» {paymentUrl, orderId}
deactivate Backend

activate Frontend
Frontend --> Customer: 9b. Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n\ntrang thanh toÃ¡n VNPay
deactivate Frontend

end

== Giai Ä‘oáº¡n 3: Xá»­ lÃ½ thanh toÃ¡n VNPay ==

Customer -> VNPay: 10. Nháº­p thÃ´ng tin thanh toÃ¡n\n(Tháº», OTP, v.v.)
activate VNPay

VNPay -> VNPay: XÃ¡c thá»±c tháº»\n& xá»­ lÃ½ thanh toÃ¡n
note right: ğŸ¦ Xá»­ lÃ½ á»Ÿ NgÃ¢n hÃ ng:\n âœ“ Tháº» há»£p lá»‡\n âœ“ Äá»§ sá»‘ dÆ°\n âœ“ OTP Ä‘Ã£ xÃ¡c minh

alt Thanh toÃ¡n ThÃ nh cÃ´ng

VNPay -> VNPay: Táº¡o pháº£n há»“i (MÃ£="00")
VNPay -> Customer: 11a. Chuyá»ƒn hÆ°á»›ng vá» Return URL\n/api/vnpay/return\n?vnp_ResponseCode=00...

else Thanh toÃ¡n Tháº¥t báº¡i hoáº·c Bá»‹ há»§y

VNPay -> VNPay: Táº¡o pháº£n há»“i (MÃ£!="00")
note right: âŒ Pháº£n há»“i Tháº¥t báº¡i:\n - vnp_ResponseCode: 24 (KhÃ¡ch hÃ ng há»§y)\n - vnp_ResponseCode: 51 (KhÃ´ng Ä‘á»§ sá»‘ dÆ°)
VNPay -> Customer: 11b. Chuyá»ƒn hÆ°á»›ng vá» Return URL\n/api/vnpay/return\n?vnp_ResponseCode=24...

end

deactivate VNPay

== Giai Ä‘oáº¡n 4: Xá»­ lÃ½ Return URL (XÃ¡c nháº­n qua Client) ==

Customer -> Backend: 12. TrÃ¬nh duyá»‡t Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng Ä‘áº¿n\nGET /api/vnpay/return?...
activate Backend

Backend -> Backend: 13. XÃ¡c thá»±c checksum\n(HMAC-SHA512)

alt Checksum KHÃ”NG Há»¢P Lá»†

Backend --> Customer: 14a. HTTP 302 Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n\n/payment-error?code=INVALID_SIGNATURE

else Checksum Há»¢P Lá»†

Backend -> Backend: 15. TrÃ­ch xuáº¥t `vnp_ResponseCode`,\n`vnp_TxnRef`, `vnp_Amount`

Backend -> Database: 16. TÃ¬m Payment báº±ng `vnp_TxnRef`\n(vÃ  Order liÃªn quan)
activate Database
Database --> Backend: {payment, order}
deactivate Database

Backend -> Backend: 17. Kiá»ƒm tra: Sá»‘ tiá»n khá»›p?\n(vnp_Amount/100 == payment.amount)
Backend -> Backend: 18. Kiá»ƒm tra: Tráº¡ng thÃ¡i Payment == "PENDING"?\n(Kiá»ƒm tra Idempotency - trÃ¡nh F5)

alt Kiá»ƒm tra THáº¤T Báº I (Sai sá»‘ tiá»n hoáº·c ÄÃ£ xá»­ lÃ½)

Backend --> Customer: 19a. HTTP 302 Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n\n/orders/{orderId}?status=error

else Kiá»ƒm tra THÃ€NH CÃ”NG

    alt Thanh toÃ¡n THÃ€NH CÃ”NG (MÃ£ == "00")
    
    Backend -> Database: 20a. Cáº­p nháº­t Payment\n{status: "SUCCESS"}
    activate Database
    Database --> Backend: OK
    deactivate Database
    
    Backend -> Database: 21a. Cáº­p nháº­t Order\n{status: "CONFIRMED"}
    activate Database
    Database --> Backend: OK
    deactivate Database
    
    note right: âœ… XÃC NHáº¬N THÃ€NH CÃ”NG!\n- Trá»« kho (inventory)\n- Gá»­i email cho khÃ¡ch
    
    Backend --> Customer: 22a. HTTP 302 Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n\n/orders/{orderId}?status=success
    
    else Thanh toÃ¡n THáº¤T Báº I (MÃ£ != "00")
    
    Backend -> Database: 20b. Cáº­p nháº­t Payment\n{status: "FAILED"}
    activate Database
    Database --> Backend: OK
    deactivate Database
    
    Backend -> Database: 21b. Cáº­p nháº­t Order\n{status: "CANCELLED"}
    activate Database
    Database --> Backend: OK
    deactivate Database
    
    note right: âŒ Giao dá»‹ch tháº¥t báº¡i.\nÄÆ¡n hÃ ng Ä‘Ã£ bá»‹ há»§y.
    
    Backend --> Customer: 22b. HTTP 302 Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n\n/orders/{orderId}?status=failed
    
    end

end

end
deactivate Backend

Customer -> Frontend: 23. TrÃ¬nh duyá»‡t Ä‘Æ°á»£c chuyá»ƒn hÆ°á»›ng Ä‘áº¿n\n/orders/{orderId}?status=...
activate Frontend

Frontend -> Backend: 24. GET /api/orders/{orderId}\n(Ä‘á»ƒ láº¥y tráº¡ng thÃ¡i Má»šI NHáº¤T)
activate Backend
Backend --> Frontend: 25. {order..., status: "CONFIRMED" hoáº·c "CANCELLED"}
deactivate Backend

Frontend --> Customer: 26. Hiá»ƒn thá»‹ Trang Chi tiáº¿t ÄÆ¡n hÃ ng
note right
    Hiá»ƒn thá»‹ trang chi tiáº¿t Ä‘Æ¡n hÃ ng:
     - Náº¿u status=success:
       "Thanh toÃ¡n thÃ nh cÃ´ng!"
     - Náº¿u status=failed:
       "Thanh toÃ¡n tháº¥t báº¡i.\nÄÆ¡n hÃ ng Ä‘Ã£ bá»‹ há»§y."
end note
deactivate Frontend

@enduml